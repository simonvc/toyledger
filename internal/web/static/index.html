<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>miniledger</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #1e1e1e;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #terminal-container {
            width: 100%;
            height: 100%;
        }
        #help-hint {
            position: fixed;
            bottom: 6px;
            right: 10px;
            color: #555;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            pointer-events: none;
            z-index: 10;
        }
        kbd {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 1px 4px;
            font-family: inherit;
            font-size: inherit;
            color: #777;
        }
        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.92);
            border: 1px solid #555;
            border-radius: 6px;
            padding: 12px 24px;
            color: #d4d4d4;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #toast.show { opacity: 1; }
        #watermark {
            position: fixed;
            bottom: 28px;
            right: 16px;
            text-align: right;
            pointer-events: none;
            z-index: 10;
            opacity: 0.12;
            font-family: 'JetBrains Mono', monospace;
        }
        #wm-title {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 2px;
        }
        #wm-sub {
            font-size: 20px;
            font-style: italic;
            color: #fff;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div id="terminal-container"></div>
    <div id="toast"></div>
    <div id="help-hint"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>S</kbd> share ledger &nbsp; <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>X</kbd> reset ledger</div>
    <div id="watermark">
        <div id="wm-title">P A V E B A N K</div>
        <div id="wm-sub">an experiment by simon@pavebank.com</div>
    </div>

    <script type="module">
        import { init, Terminal, FitAddon } from 'https://esm.sh/ghostty-web@latest';

        await init();

        const container = document.getElementById('terminal-container');

        // Wait for web font to load so cell metrics are correct.
        await document.fonts.ready;

        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: '"JetBrains Mono", Monaco, Menlo, "Courier New", monospace',
            theme: {
                background: '#1e1e1e',
                foreground: '#d4d4d4',
            },
            scrollback: 10000,
        });

        const fitAddon = new FitAddon();
        term.loadAddon(fitAddon);
        term.open(container);
        fitAddon.fit();

        window.addEventListener('resize', () => fitAddon.fit());

        function showToast(msg) {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }

        function getSessionID() {
            const m = document.cookie.match(/(?:^|;\s*)miniledger_session=([0-9a-f-]+)/);
            return m ? m[1] : null;
        }

        // Ctrl+Shift+S: copy share URL to clipboard
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                e.stopPropagation();
                const sid = getSessionID();
                if (!sid) { showToast('[No active session]'); return; }
                const url = `${location.origin}/join/${sid}`;
                navigator.clipboard.writeText(url).then(
                    () => showToast('[This ledger URL copied to clipboard]'),
                    () => showToast('[Clipboard copy failed]'),
                );
            }
        }, true);

        // Ctrl+Shift+X: reset ledger and start fresh
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'X') {
                e.preventDefault();
                e.stopPropagation();
                if (confirm('Reset ledger? This deletes all data and starts fresh.')) {
                    fetch('/reset', { method: 'POST' })
                        .then(() => location.reload())
                        .catch((err) => alert('Reset failed: ' + err));
                }
            }
        }, true);

        function connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/ws?cols=${term.cols}&rows=${term.rows}`;
            const ws = new WebSocket(wsUrl);

            ws.binaryType = 'arraybuffer';
            ws.onopen = () => term.focus();

            ws.onmessage = (e) => term.write(new Uint8Array(e.data));

            ws.onclose = () => {
                // Auto-reconnect: reload to get a fresh session if needed.
                setTimeout(() => location.reload(), 500);
            };

            term.onData((data) => {
                if (ws.readyState === WebSocket.OPEN) ws.send(data);
            });

            term.onResize(({ cols, rows }) => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'resize', cols, rows }));
                }
            });
        }

        connect();
    </script>
</body>
</html>
